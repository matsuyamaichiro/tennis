<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>YouTubeテニス動画スコア字幕作成アプリ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }

    label {
      font-size: inherit;
    }

    button {
      margin: 2px;
      background-color: #333;
      border-radius: 30px;
      color: #fff;
      padding: 5px 10px;
      cursor: pointer;
    }

    button:hover {
      background-color: #555;
    }

    /* 強調ボタン */
    .action-primary {
      background-color: #007bff;
      font-size: 1.1em;
      padding: 10px 20px;
      border-radius: 25px;
      margin: 8px 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: background-color .2s;
    }

    .action-primary:hover {
      background-color: #0056b3;
    }

    /* 加算ボタン */
    .plus {
      background-color: #007bff;
      font-size: 1.2em;
      padding: 8px 14px;
      border: none;
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
    }

    .plus:hover {
      background-color: #0056b3;
    }

    .scores {
      font-size: 1.2em;
      padding: 5px;
    }

    .score-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    input[type="text"] {
      font-size: 1.4em;
      padding: 6px 10px;
      width: 100%;
      box-sizing: border-box;
    }

    input[type="radio"] {
      transform: scale(1.5);
      margin: 8px;
      cursor: pointer;
    }

    #player {
      width: 100%;
      height: auto;
    }

    /* 高さは JS で都度設定 */
    #player iframe {
      width: 100%;
      height: 100%;
      display: block;
      border: none;
    }
  </style>
</head>

<body>
  <h1>YouTubeテニス動画スコア字幕作成アプリ</h1>

  <!-- 動画URL入力 -->
  <label>YouTube動画URL:
    <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
  </label>
  <button id="loadBtn">動画読み込み</button><br><br>

  <!-- YouTubeプレーヤー -->
  <div id="player"></div><br>

  <!-- 以降：スコア入力UI（省略せずに掲載） -->
  <table>
    <tr>
      <th></th>
      <th>Player 1</th>
      <th>Player 2</th>
    </tr>

    <tr>
      <td>名前</td>
      <td><input type="text" id="player1" value="Player 1"></td>
      <td><input type="text" id="player2" value="Player 2"></td>
      <td></td>
    </tr>

    <tr>
      <td>サーブ権</td>
      <td><input type="radio" name="server" id="serveP1" value="p1" checked></td>
      <td><input type="radio" name="server" id="serveP2" value="p2"></td>
      <td></td>
    </tr>

    <!-- ゲーム数 -->
    <tr>
      <td>ゲーム数</td>
      <td>
        <div class="score-buttons">
          <span class="scores" id="p1Game">0</span>
          <button class="plus" onclick="adjustGame('p1',1)">＋</button>
          <button onclick="adjustGame('p1',-1)">−</button>
        </div>
      </td>
      <td>
        <div class="score-buttons">
          <span class="scores" id="p2Game">0</span>
          <button class="plus" onclick="adjustGame('p2',1)">＋</button>
          <button onclick="adjustGame('p2',-1)">−</button>
        </div>
      </td>
      <td></td>
    </tr>

    <!-- ポイント -->
    <tr>
      <td>ポイント</td>
      <td>
        <div class="score-buttons">
          <span class="scores" id="p1Point">0</span>
          <button class="plus" onclick="adjustPoint('p1',1)">＋</button>
          <button onclick="adjustPoint('p1',-1)">−</button>
        </div>
      </td>
      <td>
        <div class="score-buttons">
          <span class="scores" id="p2Point">0</span>
          <button class="plus" onclick="adjustPoint('p2',1)">＋</button>
          <button onclick="adjustPoint('p2',-1)">−</button>
        </div>
      </td>
      <td>
        <input type="checkbox" id="tiebreakMode"> タイブレーク
      </td>
    </tr>
  </table><br>

  <!-- オプション -->
  <label><input type="checkbox" id="autoSubtitle" checked>ゲーム数/ポイント変更時に字幕追加</label><br>
  <label><input type="checkbox" id="autoSwitchServe" checked>ゲーム数変更時にサーブ権切替とポイントリセット</label><br><br>

  <!-- リセット系 -->
  <button onclick="finishSet()">セット完了（次のセットへ）</button>
  <button onclick="resetGames()">ゲーム数リセット（両Player）</button>
  <button onclick="resetPoints()">ポイントリセット（両Player）</button>
  <button onclick="resetMatch()" style="background-color: #dc3545; color: white;">試合完全リセット</button><br><br>

  <!-- 字幕生成 -->
  <button class="action-primary" onclick="addSubtitle()">字幕スタート</button>
  <button onclick="addSubtitleOff()">字幕オフ</button><br><br>

  <!-- ダウンロード -->
  <button class="action-primary" onclick="downloadVTT()">字幕(VTT)ファイルをダウンロード</button><br><br>

  <input type="file" id="vttFileInput" accept=".vtt">
  <button onclick="loadVTTFile()">字幕(VTT)ファイル読み込み</button>

  <div id="studioLinkContainer" style="margin-top:10px;"></div>

  <h2>字幕リスト（時刻順）</h2>
  <ul id="subtitleList"></ul>

  <h2>生成された字幕データ</h2>
  <textarea id="vttOutput" rows="12" readonly style="width:100%;"></textarea>

  <hr>
  <h2>このアプリの使い方</h2>
  <ol>
    <li>YouTubeにアップロードしたテニス動画のURLを入力して「動画読み込み」ボタンを押します。</li>
    <li>Player1とPlayer2の名前（ダブルスなら"錦織・西岡"のように２人分）を入力します。</li>
    <li>最初にサーブ権を持つPlayerにチェックを入れます。</li>
    <li>試合開始時に0-0の状態で「字幕スタート」ボタンを押し、最初の字幕を追加します。</li>
    <li>動画を再生・一時停止しながら、ポイント数を「+」「−」ボタンで加減すると字幕が更新されます。</li>
    <li>タイブレークのゲームは、予めタイブレークのチェックボックスをオンにして下さい。奇数ポイント毎にサーブ権が入れ替わります。</li>
    <li>ゲームを「+」「-」ボタンで加減すると、サーブ権が入れ替わり、ポイントがリセットされ、字幕が更新されます。</li>
    <li>ゲーム終了時など、字幕を消したい場合は「字幕オフ」ボタンで字幕を非表示にします。</li>
    <li>セットが終わったら「セット完了」ボタンを押すと、そのセットのスコアが確定・保存され、次のセット（0-0）に進みます。</li>
    <li>動画内で別の試合に切り替わる場合、「試合完全リセット」ボタンを押して、Playerの名前指定から再度実施してください。</li>
    <li>最後に「字幕(VTT)ファイルをダウンロード」ボタンで .vtt ファイルを保存します。</li>
    <li>ダウンロードした .vtt ファイルをYouTube Studioで動画に字幕としてアップロードしてください。</li>
  </ol>
  <ul>
    <li>字幕リストで「編集」ボタンを押すと、時刻⇒Player1⇒Player2の順で字幕内容を編集できます。</li>
    <li>字幕リストで「削除」ボタンにより、削除も可能です。</li>
    <li>現在のゲーム数やポイントを修正するときは、「ゲーム数/ポイント変更時に字幕追加」や「ゲーム数変更時にサーブ権切り替えとポイントリセット」のチェックボックスを一旦OFFにして下さい。</li>
    <li>.vttファイルを読み込んで編集することもできます。途中から再開するときに便利かも。</li>
    <li>YouTube Studioで字幕をアップロードできるのは、動画作成者のみです。</li>
    <li>このアプリの利用によって生じた損害等の責任は負いません。</li>
  </ul>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ---------- 変数 ----------
    let player = null;
    const pointsOrder = ['0', '15', '30', '40', 'Adv'];
    let [p1Game, p2Game, p1Point, p2Point] = [0, 0, 0, 0];
    let previousSets = []; // 完了したセットのスコア履歴 [{p1:6, p2:4}, ...]
    let isTiebreak = false;
    let subtitles = [];

    // ---------- YouTube API初期化 ----------
    function onYouTubeIframeAPIReady() {
      document.getElementById('loadBtn').onclick = () => {
        const inputURL = document.getElementById('youtubeUrl').value.trim();
        const vid = extractVideoId(inputURL);
        if (!vid) { alert('有効なURLを入力してください'); return; }
        if (!player) createPlayer(vid);
        else player.loadVideoById(vid);
        resizePlayer(); // 生成直後もサイズ調整
        // Studioリンク
        document.getElementById('studioLinkContainer').innerHTML =
          `<a href="https://studio.youtube.com/video/${vid}/edit" target="_blank" rel="noopener noreferrer">
             🎬 この動画のYouTube Studioページ（字幕アップロード）
           </a>`;
      };

      document.getElementById('tiebreakMode').onchange = e => {
        isTiebreak = e.target.checked;
        refreshPointDisplays();
      };
    }

    // ---------- プレーヤー生成 ----------
    function createPlayer(videoId) {
      player = new YT.Player('player', {
        videoId,
        events: { onReady: resizePlayer } // APIがreadyになったらリサイズ
      });
    }

    // ---------- リサイズ共通処理 ----------
    function resizePlayer() {
      if (!player || !player.setSize) return;
      const w = window.innerWidth;
      let h = Math.round(w * 9 / 16);
      if (h > window.innerHeight) { h = window.innerHeight; } // はみ出し防止
      player.setSize(w, h);
      document.getElementById('player').style.height = h + 'px';
    }

    // ウィンドウリサイズ・端末回転・初回ロード
    ['resize', 'orientationchange', 'load'].forEach(ev =>
      window.addEventListener(ev, resizePlayer));

    // ---------- URLからvideoId抽出 ----------
    function extractVideoId(url) {
      try {
        const u = new URL(url);
        if (u.hostname === 'youtu.be') return u.pathname.slice(1);
        if (u.hostname.includes('youtube')) return u.searchParams.get('v');
      } catch (e) { }
      return null;
    }

    // ---------- スコア操作（adjustGame / adjustPoint など既存ロジックはそのまま） ----------
    function adjustGame(key, delta) {
      if (key === 'p1') { p1Game = Math.max(0, p1Game + delta); document.getElementById('p1Game').textContent = p1Game; }
      else { p2Game = Math.max(0, p2Game + delta); document.getElementById('p2Game').textContent = p2Game; }

      if (document.getElementById('autoSwitchServe').checked) {
        if (isTiebreak) {
          mod4 = (p1Point + p2Point) % 4;
          p1Point = p2Point = 0;
          document.getElementById('p1Point').textContent = p1Point;
          document.getElementById('p2Point').textContent = p2Point;
          if (mod4 === 0 || mod4 === 3) {
            toggleServe(); // タイブレーク時はサーブ開始側から相手側にサーブ権を切り替え
          }
        } else {
          p1Point = p2Point = 0;
          document.getElementById('p1Point').textContent = pointsOrder[p1Point];
          document.getElementById('p2Point').textContent = pointsOrder[p2Point];
          toggleServe();
        }
      }
      if (document.getElementById('autoSubtitle').checked) addSubtitle();
    }

    function adjustPoint(key, delta) {
      if (isTiebreak) {
        if (key === 'p1') {
          p1Point = Math.max(0, p1Point + delta);
          document.getElementById('p1Point').textContent = p1Point;
        }
        else {
          p2Point = Math.max(0, p2Point + delta);
          document.getElementById('p2Point').textContent = p2Point;
        }
        if (document.getElementById('autoSwitchServe').checked) {
          if ((p1Point + p2Point) % 2 != 0) { toggleServe(); }
        }
      } else {
        if (key === 'p1') {
          p1Point = (p1Point + delta + pointsOrder.length) % pointsOrder.length;
          document.getElementById('p1Point').textContent = pointsOrder[p1Point];
        }
        else {
          p2Point = (p2Point + delta + pointsOrder.length) % pointsOrder.length;
          document.getElementById('p2Point').textContent = pointsOrder[p2Point];
        }
      }
      if (document.getElementById('autoSubtitle').checked) addSubtitle();
    }

    function resetGames() {
      p1Game = 0;
      p2Game = 0;
      document.getElementById('p1Game').textContent = p1Game;
      document.getElementById('p2Game').textContent = p2Game;
    }

    function finishSet() {
      // 現在のセットスコアを履歴に保存
      previousSets.push({ p1: p1Game, p2: p2Game });

      // ゲーム数・ポイントリセット
      resetGames();
      resetPoints();

      // タイブレークモード解除（次のセットは通常から始まるため）
      isTiebreak = false;
      document.getElementById('tiebreakMode').checked = false;
      refreshPointDisplays();

      // 必要に応じてサーブ権などはそのまま or リセット？
      // 通常はセット変わっても順番通りだが、ここでは自動切替に任せるか、
      // ユーザーが手動で調整することを想定。とりあえずそのままで。

      // セット終了時も字幕を出したい場合はここでも addSubtitle() 呼ぶ？
      // ただし 0-0 になっているので、出すなら "6-4 0-0" のような表示になる。
      if (document.getElementById('autoSubtitle').checked) addSubtitle();
    }

    function resetMatch() {
      if (!confirm('本当に試合全体をリセットしますか？\n（名前以外のスコア・セット履歴が全て消えます）')) return;
      previousSets = [];
      resetGames();
      resetPoints();
      // サーブ権も初期値(Player1)に戻すなら以下
      document.getElementById('serveP1').checked = true;
      document.getElementById('serveP2').checked = false;
      isTiebreak = false;
      document.getElementById('tiebreakMode').checked = false;
      refreshPointDisplays();
    }

    function resetPoints() {
      p1Point = 0;
      p2Point = 0;
      refreshPointDisplays();
    }

    function refreshPointDisplays() {
      if (isTiebreak) {
        // タイブレーク中は生の数字を表示
        document.getElementById('p1Point').textContent = String(p1Point);
        document.getElementById('p2Point').textContent = String(p2Point);
      } else {
        // 通常時は 0 / 15 / 30 / 40 / Adv 表示
        document.getElementById('p1Point').textContent = pointsOrder[p1Point];
        document.getElementById('p2Point').textContent = pointsOrder[p2Point];
      }
    }

    function toggleServe() {
      const serveP1 = document.getElementById('serveP1');
      const serveP2 = document.getElementById('serveP2');
      if (serveP1.checked) {
        serveP1.checked = false;
        serveP2.checked = true;
      } else {
        serveP1.checked = true;
        serveP2.checked = false;
      }
    }

    function addSubtitle() {
      if (!player) { alert('動画が読み込まれていません'); return; }
      const time = player.getCurrentTime();

      let p1Name = document.getElementById('player1').value || 'Player 1';
      let p2Name = document.getElementById('player2').value || 'Player 2';

      if (document.getElementById('serveP1').checked) {
        p1Name = '*' + p1Name;
      } else {
        p2Name = '*' + p2Name;
      }

      const p1Pt = isTiebreak ? String(p1Point) : pointsOrder[p1Point];
      const p2Pt = isTiebreak ? String(p2Point) : pointsOrder[p2Point];

      // 過去のセットスコア文字列作成
      let p1SetsStr = previousSets.map(s => s.p1).join(' ');
      let p2SetsStr = previousSets.map(s => s.p2).join(' ');
      if (p1SetsStr) p1SetsStr += ' ';
      if (p2SetsStr) p2SetsStr += ' ';

      const line1 = `${p1Name}: ${p1SetsStr}${p1Game} ${p1Pt}`;
      const line2 = `${p2Name}: ${p2SetsStr}${p2Game} ${p2Pt}`;

      subtitles.push({ time, line1, line2 });
      updateSubtitleList();
      updateVTT();
    }

    function updateSubtitleList() {
      const list = document.getElementById('subtitleList');
      list.innerHTML = '';

      subtitles.sort((a, b) => a.time - b.time);
      subtitles.forEach((s, index) => {
        const li = document.createElement('li');
        let displayLine = (s.line1 || s.line2) ? `"${s.line1} / ${s.line2}"` : '字幕オフ';
        li.textContent = `${index + 1}: ${formatTime(s.time)} - ${displayLine}`;

        const editBtn = document.createElement('button');
        editBtn.textContent = '編集';
        editBtn.onclick = () => editSubtitle(index);

        const delBtn = document.createElement('button');
        delBtn.textContent = '削除';
        delBtn.onclick = () => { subtitles.splice(index, 1); updateSubtitleList(); updateVTT(); };

        li.appendChild(editBtn);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    function editSubtitle(index) {
      const newTime = prompt('新しい時間（秒）', subtitles[index].time);
      if (newTime !== null && !isNaN(newTime)) {
        subtitles[index].time = parseFloat(newTime);
        const newLine1 = prompt('1行目のテキスト', subtitles[index].line1);
        const newLine2 = prompt('2行目のテキスト', subtitles[index].line2);
        if (newLine1 !== null) subtitles[index].line1 = newLine1;
        if (newLine2 !== null) subtitles[index].line2 = newLine2;
        updateSubtitleList();
        updateVTT();
      }
    }

    function updateVTT() {
      let vtt = "WEBVTT\n\n";
      subtitles.sort((a, b) => a.time - b.time).forEach((s, i) => {
        const start = formatTime(s.time);
        const end = (i + 1 < subtitles.length) ? formatTime(subtitles[i + 1].time) : "99:59:59.999";
        vtt += `${i + 1}\n${start} --> ${end}\n${s.line1}\n${s.line2}\n\n`;
      });
      document.getElementById('vttOutput').value = vtt;
    }

    function formatTime(seconds) {
      const date = new Date(0);
      date.setSeconds(seconds);
      const hh = String(date.getUTCHours()).padStart(2, '0');
      const mm = String(date.getUTCMinutes()).padStart(2, '0');
      const ss = String(date.getUTCSeconds()).padStart(2, '0');
      const ms = String(Math.floor((seconds % 1) * 1000)).padStart(3, '0');
      return `${hh}:${mm}:${ss}.${ms}`;
    }

    function downloadVTT() {
      const vtt = document.getElementById('vttOutput').value;
      const blob = new Blob([vtt], { type: "text/vtt" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "tennis_score.vtt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadVTTFile() {
      const fileInput = document.getElementById('vttFileInput');
      const file = fileInput.files[0];
      if (!file) { alert('ファイルを選択してください'); return; }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        parseVTT(text);
      };
      reader.readAsText(file);
    }

    function parseVTT(vttText) {
      subtitles = []; // 既存リスト初期化
      const blocks = vttText.split(/\n\n+/);
      for (const block of blocks) {
        const lines = block.trim().split('\n');
        if (lines.length >= 3 && lines[1].includes('-->')) {
          const timeStr = lines[1].split(' --> ')[0];
          const timeSec = parseTime(timeStr);
          const line1 = lines[2];
          const line2 = lines[3] || '';
          subtitles.push({ time: timeSec, line1, line2 });
        }
      }
      updateSubtitleList();
      updateVTT();
    }

    function parseTime(timeStr) {
      const [hh, mm, ssMs] = timeStr.split(':');
      const [ss, ms] = ssMs.split('.');
      return Number(hh) * 3600 + Number(mm) * 60 + Number(ss) + Number(ms) / 1000;
    }

    function addSubtitleOff() {
      if (!player) { alert('動画が読み込まれていません'); return; }
      const time = player.getCurrentTime();
      subtitles.push({ time, line1: '', line2: '' });
      updateSubtitleList();
      updateVTT();
    }

  </script>
</body>

</html>